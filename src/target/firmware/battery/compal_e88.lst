   1              		.file	"compal_e88.c"
   9              	.Ltext0:
  10              		.cfi_sections	.debug_frame
  11              		.section	.text.bat_compal_e88_goto_state,"ax",%progbits
  12              		.align	2
  14              	bat_compal_e88_goto_state:
  15              	.LFB13:
  16              		.file 1 "battery/compal_e88.c"
   1:battery/compal_e88.c **** /* Battery management for compal_e88 */
   2:battery/compal_e88.c **** 
   3:battery/compal_e88.c **** /* (C) 2010 by Christian Vogel <vogelchr@vogel.cx>
   4:battery/compal_e88.c ****  *
   5:battery/compal_e88.c ****  * All Rights Reserved
   6:battery/compal_e88.c ****  *
   7:battery/compal_e88.c ****  * This program is free software; you can redistribute it and/or modify
   8:battery/compal_e88.c ****  * it under the terms of the GNU General Public License as published by
   9:battery/compal_e88.c ****  * the Free Software Foundation; either version 2 of the License, or
  10:battery/compal_e88.c ****  * (at your option) any later version.
  11:battery/compal_e88.c ****  *
  12:battery/compal_e88.c ****  * This program is distributed in the hope that it will be useful,
  13:battery/compal_e88.c ****  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  14:battery/compal_e88.c ****  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  15:battery/compal_e88.c ****  * GNU General Public License for more details.
  16:battery/compal_e88.c ****  *
  17:battery/compal_e88.c ****  * You should have received a copy of the GNU General Public License along
  18:battery/compal_e88.c ****  * with this program; if not, write to the Free Software Foundation, Inc.,
  19:battery/compal_e88.c ****  * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
  20:battery/compal_e88.c ****  *
  21:battery/compal_e88.c ****  */
  22:battery/compal_e88.c **** 
  23:battery/compal_e88.c **** /*
  24:battery/compal_e88.c ****  * ___C123 (compal e88) very simplified diagram of charging circuitry___
  25:battery/compal_e88.c ****  *
  26:battery/compal_e88.c ****  *                           ICTL
  27:battery/compal_e88.c ****  *                            |
  28:battery/compal_e88.c ****  *                            v
  29:battery/compal_e88.c ****  *  Charger -> OVP -------> P-Mosfet --->[0.15 Ohm]---> Battery
  30:battery/compal_e88.c ****  *             (NCP345,  |             |            |
  31:battery/compal_e88.c ****  *              6.85V)   v             v            v
  32:battery/compal_e88.c ****  *                      VCHG          VCCS        VBAT &
  33:battery/compal_e88.c ****  *                                                VBATS
  34:battery/compal_e88.c ****  *
  35:battery/compal_e88.c ****  * Inputs to IOTA:
  36:battery/compal_e88.c ****  *  VCHG:        senses voltage on the charger input
  37:battery/compal_e88.c ****  *  VCSS/VBATS:  to difference amplifier, to measure charge current
  38:battery/compal_e88.c ****  *  VBAT:        senses voltage on the battery terminal
  39:battery/compal_e88.c ****  * Outputs from IOTA:
  40:battery/compal_e88.c ****  *  ICTL:        Control signal for the switching mosfet
  41:battery/compal_e88.c ****  *
  42:battery/compal_e88.c ****  */
  43:battery/compal_e88.c **** 
  44:battery/compal_e88.c **** #include <battery/battery.h>
  45:battery/compal_e88.c **** #include <battery/compal_e88.h>
  46:battery/compal_e88.c **** 
  47:battery/compal_e88.c **** #include <stdint.h>
  48:battery/compal_e88.c **** #include <abb/twl3025.h>
  49:battery/compal_e88.c **** #include <comm/timer.h>
  50:battery/compal_e88.c **** #include <stdio.h>
  51:battery/compal_e88.c **** 
  52:battery/compal_e88.c **** /* ADC calibration, scale is LSB/uV or LSB/uA, physical unit is mV or mA */
  53:battery/compal_e88.c **** #define ADC_TO_PHYSICAL(adc,scale) (((adc)*(scale)+500)/1000)
  54:battery/compal_e88.c **** #define PHYSICAL_TO_ADC(phy,scale) (((phy)*1000+(scale)/2)/(scale))
  55:battery/compal_e88.c **** 
  56:battery/compal_e88.c **** /* conversion factors for internal IOTA battery charging/sensing circuitry */
  57:battery/compal_e88.c **** #define VREF_LSB_uV 1709  /* VREF = 1.75V    --> 1.709 mV/LSB */
  58:battery/compal_e88.c **** #define VBAT_LSB_uV 6836  /* VBAT = 7.0 V FS --> 6.836 mV/LSB */
  59:battery/compal_e88.c **** #define VCHG_LSB_uV 8545  /* VCHG = 8.75V FS --> 8.545 mV/LSB */
  60:battery/compal_e88.c **** #define ICHG_LSB_uA 854   /* ICHG = 875mA FS --> 0.854 mA/LSB */
  61:battery/compal_e88.c **** 
  62:battery/compal_e88.c **** /* battery is considered full/empty at these thresholds... */
  63:battery/compal_e88.c **** #define VBAT_full   PHYSICAL_TO_ADC(4000,VBAT_LSB_uV)
  64:battery/compal_e88.c **** #define VBAT_empty  PHYSICAL_TO_ADC(3200,VBAT_LSB_uV)
  65:battery/compal_e88.c **** 
  66:battery/compal_e88.c **** /* we declare overvoltage at this point... */
  67:battery/compal_e88.c **** #define VBAT_fail   PHYSICAL_TO_ADC(4250,VBAT_LSB_uV)
  68:battery/compal_e88.c **** 
  69:battery/compal_e88.c **** /* DAC to ADC offsets in CC mode with my C123 
  70:battery/compal_e88.c ****    IMEI 358317015976471, P329431014
  71:battery/compal_e88.c **** 
  72:battery/compal_e88.c ****    I/mA DAC     ADC
  73:battery/compal_e88.c ****    ----------------
  74:battery/compal_e88.c ****    100	117	108
  75:battery/compal_e88.c ****    150	176	168
  76:battery/compal_e88.c ****    200	234	227
  77:battery/compal_e88.c ****    250	293	291
  78:battery/compal_e88.c ****    300	351	349
  79:battery/compal_e88.c ****    350	410	410
  80:battery/compal_e88.c **** */
  81:battery/compal_e88.c **** 
  82:battery/compal_e88.c **** #define CHGDAC_GAIN   967  /* times 0.001 */
  83:battery/compal_e88.c **** #define CHGDAC_OFFS    13
  84:battery/compal_e88.c **** 
  85:battery/compal_e88.c **** /* convert ADC reading to DAC value, according to calibration values
  86:battery/compal_e88.c ****    given above */
  87:battery/compal_e88.c **** #define CHGDAC_ADJ(x)   (CHGDAC_GAIN*(x)/1000+CHGDAC_OFFS)
  88:battery/compal_e88.c **** 
  89:battery/compal_e88.c **** /* charging current in DAC LSBs, same ref. and # of bits, but keep
  90:battery/compal_e88.c ****    the correction specified above in mind!  */
  91:battery/compal_e88.c **** 
  92:battery/compal_e88.c **** #define ICHG_set    CHGDAC_ADJ(PHYSICAL_TO_ADC(200,ICHG_LSB_uA))
  93:battery/compal_e88.c **** #define VCHG_set    CHGDAC_ADJ(VBAT_full)
  94:battery/compal_e88.c **** 
  95:battery/compal_e88.c **** struct battery_info battery_info;	/* global battery info */
  96:battery/compal_e88.c **** uint16_t bat_compal_e88_madc[MADC_NUM_CHANNELS];	/* MADC measurements */
  97:battery/compal_e88.c **** 
  98:battery/compal_e88.c **** static const int BATTERY_TIMER_DELAY=5000; /* 5000ms for control loop */
  99:battery/compal_e88.c **** static const int ADC_TIMER_DELAY=100;      /*  100ms for ADC conversion */
 100:battery/compal_e88.c **** 
 101:battery/compal_e88.c **** /* thermistor sense current, turn it up to eleven! */
 102:battery/compal_e88.c **** #define  TH_SENS               (THSENS0|THSENS1|THSENS2|THEN)
 103:battery/compal_e88.c **** #define  BATTERY_ALL_SENSE     (TH_SENS|MESBAT|TYPEN)
 104:battery/compal_e88.c **** 
 105:battery/compal_e88.c **** /*
 106:battery/compal_e88.c ****  * charger modes state machine
 107:battery/compal_e88.c ****  *
 108:battery/compal_e88.c ****  *    +------------------+-------------------+
 109:battery/compal_e88.c ****  *    |                  |                   | lost AC power
 110:battery/compal_e88.c ****  *    |                  ^                   ^
 111:battery/compal_e88.c ****  *    V  on AC power     |    @VBAT_full     |
 112:battery/compal_e88.c ****  * +-----+        +------------+ -----> +------------+
 113:battery/compal_e88.c ****  * | OFF | -----> | CONST_CURR |        | CONST_VOLT |
 114:battery/compal_e88.c ****  * +-----+        +------------+        +------------+
 115:battery/compal_e88.c ****  *    ^          ^        |                   |
 116:battery/compal_e88.c ****  *    |         /failure  v                   v failure
 117:battery/compal_e88.c ****  * +---------+ /  gone    |                   | condition
 118:battery/compal_e88.c ****  * | FAILURE | <----------+-------------------+
 119:battery/compal_e88.c ****  * +---------+
 120:battery/compal_e88.c ****  *
 121:battery/compal_e88.c ****  *  Failure modes currently detected:
 122:battery/compal_e88.c ****  *          + high battery voltage
 123:battery/compal_e88.c ****  *  Failure modes TODO:
 124:battery/compal_e88.c ****  *          + high battery temperature
 125:battery/compal_e88.c ****  */
 126:battery/compal_e88.c **** enum bat_compal_e88_chg_state {
 127:battery/compal_e88.c **** 	CHARG_OFF,
 128:battery/compal_e88.c **** 	CHARG_CONST_CURR,
 129:battery/compal_e88.c **** 	CHARG_CONST_VOLT,
 130:battery/compal_e88.c **** 	CHARG_FAIL
 131:battery/compal_e88.c **** };
 132:battery/compal_e88.c **** static enum bat_compal_e88_chg_state bat_compal_e88_chg_state;
 133:battery/compal_e88.c **** 
 134:battery/compal_e88.c **** static const char *bat_compal_e88_chg_state_names[]={
 135:battery/compal_e88.c **** 	"Off",
 136:battery/compal_e88.c **** 	"Constant Current",
 137:battery/compal_e88.c **** 	"Constant Voltage",
 138:battery/compal_e88.c **** 	"Battery Failure"
 139:battery/compal_e88.c **** };
 140:battery/compal_e88.c **** 
 141:battery/compal_e88.c **** static void
 142:battery/compal_e88.c **** bat_compal_e88_goto_state(enum bat_compal_e88_chg_state newstate){
  17              		.loc 1 142 0
  18              		.cfi_startproc
  19              		@ args = 0, pretend = 0, frame = 0
  20              		@ frame_needed = 0, uses_anonymous_args = 0
  21              	.LVL0:
 143:battery/compal_e88.c **** 
 144:battery/compal_e88.c **** 	if(bat_compal_e88_chg_state == newstate) /* already there? */
  22              		.loc 1 144 0
  23 0000 14319FE5 		ldr	r3, .L10
  24 0004 002093E5 		ldr	r2, [r3, #0]
  25 0008 000052E1 		cmp	r2, r0
 142:battery/compal_e88.c **** bat_compal_e88_goto_state(enum bat_compal_e88_chg_state newstate){
  26              		.loc 1 142 0
  27 000c 30402DE9 		stmfd	sp!, {r4, r5, lr}
  28              	.LCFI0:
  29              		.cfi_def_cfa_offset 12
 142:battery/compal_e88.c **** bat_compal_e88_goto_state(enum bat_compal_e88_chg_state newstate){
  30              		.loc 1 142 0
  31 0010 0040A0E1 		mov	r4, r0
  32              		.cfi_offset 14, -4
  33              		.cfi_offset 5, -8
  34              		.cfi_offset 4, -12
  35              		.loc 1 144 0
  36 0014 3080BD08 		ldmeqfd	sp!, {r4, r5, pc}
 145:battery/compal_e88.c **** 		return;
 146:battery/compal_e88.c **** 
 147:battery/compal_e88.c **** 	printf("\033[34;1mCHARGER: %s --> %s.\033[0m\n",
  37              		.loc 1 147 0
  38 0018 00319FE5 		ldr	r3, .L10+4
  39 001c 00019FE5 		ldr	r0, .L10+8
  40              	.LVL1:
  41 0020 021193E7 		ldr	r1, [r3, r2, asl #2]
  42 0024 042193E7 		ldr	r2, [r3, r4, asl #2]
  43 0028 FEFFFFEB 		bl	printf
 148:battery/compal_e88.c **** 			bat_compal_e88_chg_state_names[bat_compal_e88_chg_state],
 149:battery/compal_e88.c **** 			bat_compal_e88_chg_state_names[newstate]);
 150:battery/compal_e88.c **** 
 151:battery/compal_e88.c **** 	/* update user visible flags, set registers */
 152:battery/compal_e88.c **** 	switch(newstate){
  44              		.loc 1 152 0
  45 002c 010054E3 		cmp	r4, #1
  46 0030 0300000A 		beq	.L4
  47 0034 020054E3 		cmp	r4, #2
  48 0038 E8309FE5 		ldr	r3, .L10+12
  49 003c 2100001A 		bne	.L7
  50 0040 100000EA 		b	.L9
  51              	.L4:
 153:battery/compal_e88.c **** 	case CHARG_CONST_CURR:
 154:battery/compal_e88.c **** 		battery_info.flags &= ~BATTERY_FAILURE;
 155:battery/compal_e88.c **** 		battery_info.flags |= (BATTERY_CHG_ENABLED|
  52              		.loc 1 155 0
  53 0044 DC309FE5 		ldr	r3, .L10+12
 154:battery/compal_e88.c **** 		battery_info.flags &= ~BATTERY_FAILURE;
  54              		.loc 1 154 0
  55 0048 002093E5 		ldr	r2, [r3, #0]
  56 004c 0820C2E3 		bic	r2, r2, #8
  57              		.loc 1 155 0
  58 0050 062082E3 		orr	r2, r2, #6
  59 0054 002083E5 		str	r2, [r3, #0]
 156:battery/compal_e88.c **** 						BATTERY_CHARGING);
 157:battery/compal_e88.c **** 		twl3025_reg_write(BCICTL2,0);
  60              		.loc 1 157 0
  61 0058 1D00A0E3 		mov	r0, #29
  62 005c 0010A0E3 		mov	r1, #0
  63 0060 FEFFFFEB 		bl	twl3025_reg_write
 158:battery/compal_e88.c **** 		twl3025_reg_write(CHGREG,0);
  64              		.loc 1 158 0
  65 0064 1900A0E3 		mov	r0, #25
  66 0068 0010A0E3 		mov	r1, #0
  67 006c FEFFFFEB 		bl	twl3025_reg_write
 159:battery/compal_e88.c **** 		twl3025_reg_write(BCICTL2,CHEN|LEDC|CHIV);
  68              		.loc 1 159 0
  69 0070 1D00A0E3 		mov	r0, #29
  70 0074 2310A0E3 		mov	r1, #35
  71 0078 FEFFFFEB 		bl	twl3025_reg_write
 160:battery/compal_e88.c **** 		twl3025_reg_write(CHGREG,ICHG_set);
  72              		.loc 1 160 0
  73 007c 1900A0E3 		mov	r0, #25
  74 0080 EF10A0E3 		mov	r1, #239
  75 0084 170000EA 		b	.L8
  76              	.L9:
 161:battery/compal_e88.c **** 
 162:battery/compal_e88.c **** 		break;
 163:battery/compal_e88.c **** 
 164:battery/compal_e88.c **** 	case CHARG_CONST_VOLT:
 165:battery/compal_e88.c **** 		battery_info.flags &= ~( BATTERY_CHARGING |
  77              		.loc 1 165 0
  78 0088 002093E5 		ldr	r2, [r3, #0]
  79 008c 0C20C2E3 		bic	r2, r2, #12
 166:battery/compal_e88.c **** 						BATTERY_FAILURE );
 167:battery/compal_e88.c **** 		battery_info.flags |= BATTERY_CHG_ENABLED;
  80              		.loc 1 167 0
  81 0090 022082E3 		orr	r2, r2, #2
  82 0094 002083E5 		str	r2, [r3, #0]
 168:battery/compal_e88.c **** 		twl3025_reg_write(BCICTL2,0);
  83              		.loc 1 168 0
  84 0098 1D00A0E3 		mov	r0, #29
  85 009c 0010A0E3 		mov	r1, #0
  86 00a0 FEFFFFEB 		bl	twl3025_reg_write
 169:battery/compal_e88.c **** 		twl3025_reg_write(CHGREG,0);
  87              		.loc 1 169 0
  88 00a4 1900A0E3 		mov	r0, #25
  89 00a8 0010A0E3 		mov	r1, #0
  90 00ac FEFFFFEB 		bl	twl3025_reg_write
 170:battery/compal_e88.c **** 		twl3025_reg_write(BCICTL2,CHEN|LEDC);
  91              		.loc 1 170 0
  92 00b0 1D00A0E3 		mov	r0, #29
  93 00b4 2110A0E3 		mov	r1, #33
  94 00b8 FEFFFFEB 		bl	twl3025_reg_write
 171:battery/compal_e88.c **** 		twl3025_reg_write(CHGREG,VCHG_set);
  95              		.loc 1 171 0
  96 00bc 1900A0E3 		mov	r0, #25
  97 00c0 64109FE5 		ldr	r1, .L10+16
  98 00c4 070000EA 		b	.L8
  99              	.L7:
 172:battery/compal_e88.c **** 		break;
 173:battery/compal_e88.c **** 
 174:battery/compal_e88.c **** 	case CHARG_FAIL:
 175:battery/compal_e88.c **** 	case CHARG_OFF:
 176:battery/compal_e88.c **** 	default:
 177:battery/compal_e88.c **** 		battery_info.flags &= ~( BATTERY_CHG_ENABLED |
 100              		.loc 1 177 0
 101 00c8 002093E5 		ldr	r2, [r3, #0]
 102 00cc 0E20C2E3 		bic	r2, r2, #14
 178:battery/compal_e88.c **** 			BATTERY_CHARGING | BATTERY_FAILURE );
 179:battery/compal_e88.c **** 		twl3025_reg_write(BCICTL2,0); /* turn off charger */
 103              		.loc 1 179 0
 104 00d0 1D00A0E3 		mov	r0, #29
 105 00d4 0010A0E3 		mov	r1, #0
 177:battery/compal_e88.c **** 		battery_info.flags &= ~( BATTERY_CHG_ENABLED |
 106              		.loc 1 177 0
 107 00d8 002083E5 		str	r2, [r3, #0]
 108              		.loc 1 179 0
 109 00dc FEFFFFEB 		bl	twl3025_reg_write
 180:battery/compal_e88.c **** 		twl3025_reg_write(CHGREG,0);
 110              		.loc 1 180 0
 111 00e0 1900A0E3 		mov	r0, #25
 112 00e4 0010A0E3 		mov	r1, #0
 113              	.L8:
 114 00e8 FEFFFFEB 		bl	twl3025_reg_write
 181:battery/compal_e88.c **** 		break;
 182:battery/compal_e88.c **** 	}
 183:battery/compal_e88.c **** 
 184:battery/compal_e88.c **** 	printf("BCICTL2 is 0x%03x, CHGREG=%d\n",
 185:battery/compal_e88.c **** 			twl3025_reg_read(BCICTL2),
 115              		.loc 1 185 0
 116 00ec 1D00A0E3 		mov	r0, #29
 117 00f0 FEFFFFEB 		bl	twl3025_reg_read
 118 00f4 0050A0E1 		mov	r5, r0
 186:battery/compal_e88.c **** 			twl3025_reg_read(CHGREG));
 119              		.loc 1 186 0
 120 00f8 1900A0E3 		mov	r0, #25
 121 00fc FEFFFFEB 		bl	twl3025_reg_read
 184:battery/compal_e88.c **** 	printf("BCICTL2 is 0x%03x, CHGREG=%d\n",
 122              		.loc 1 184 0
 123 0100 0510A0E1 		mov	r1, r5
 124              		.loc 1 186 0
 125 0104 0020A0E1 		mov	r2, r0
 184:battery/compal_e88.c **** 	printf("BCICTL2 is 0x%03x, CHGREG=%d\n",
 126              		.loc 1 184 0
 127 0108 20009FE5 		ldr	r0, .L10+20
 128 010c FEFFFFEB 		bl	printf
 187:battery/compal_e88.c **** 
 188:battery/compal_e88.c **** 	bat_compal_e88_chg_state = newstate;
 129              		.loc 1 188 0
 130 0110 04309FE5 		ldr	r3, .L10
 131 0114 004083E5 		str	r4, [r3, #0]
 132 0118 3080BDE8 		ldmfd	sp!, {r4, r5, pc}
 133              	.L11:
 134              		.align	2
 135              	.L10:
 136 011c 00000000 		.word	.LANCHOR0
 137 0120 00000000 		.word	.LANCHOR1
 138 0124 00000000 		.word	.LC0
 139 0128 00000000 		.word	battery_info
 140 012c 42020000 		.word	578
 141 0130 20000000 		.word	.LC1
 142              		.cfi_endproc
 143              	.LFE13:
 145              		.global	__divsi3
 146              		.section	.text.battery_compal_e88_timer_cb,"ax",%progbits
 147              		.align	2
 149              	battery_compal_e88_timer_cb:
 150              	.LFB18:
 189:battery/compal_e88.c **** }
 190:battery/compal_e88.c **** 
 191:battery/compal_e88.c **** static void
 192:battery/compal_e88.c **** bat_compal_e88_chg_control(){
 193:battery/compal_e88.c **** 	/* with AC power disconnected, always go to off state */
 194:battery/compal_e88.c **** 	if(!(battery_info.flags & BATTERY_CHG_CONNECTED)){
 195:battery/compal_e88.c **** 		bat_compal_e88_goto_state(CHARG_OFF);
 196:battery/compal_e88.c **** 		return;
 197:battery/compal_e88.c **** 	}
 198:battery/compal_e88.c **** 
 199:battery/compal_e88.c **** 	/* if failure condition is detected, always goto failure state */
 200:battery/compal_e88.c **** 	if(bat_compal_e88_madc[MADC_VBAT] > VBAT_fail){
 201:battery/compal_e88.c **** 		bat_compal_e88_goto_state(CHARG_FAIL);
 202:battery/compal_e88.c **** 		return;
 203:battery/compal_e88.c **** 	}
 204:battery/compal_e88.c **** 
 205:battery/compal_e88.c **** 	/* now AC power is present and battery is not over failure
 206:battery/compal_e88.c **** 	   thresholds */
 207:battery/compal_e88.c **** 	switch(bat_compal_e88_chg_state){
 208:battery/compal_e88.c **** 	case CHARG_OFF:
 209:battery/compal_e88.c **** 		if(bat_compal_e88_madc[MADC_VBAT] >= VBAT_full)
 210:battery/compal_e88.c **** 			bat_compal_e88_goto_state(CHARG_CONST_VOLT);
 211:battery/compal_e88.c **** 		else
 212:battery/compal_e88.c **** 			bat_compal_e88_goto_state(CHARG_CONST_CURR);
 213:battery/compal_e88.c **** 		break;
 214:battery/compal_e88.c **** 	case CHARG_CONST_CURR:
 215:battery/compal_e88.c **** 		if(bat_compal_e88_madc[MADC_VBAT] >= VBAT_full)
 216:battery/compal_e88.c **** 			bat_compal_e88_goto_state(CHARG_CONST_VOLT);
 217:battery/compal_e88.c **** 		break;
 218:battery/compal_e88.c **** 	case CHARG_CONST_VOLT:
 219:battery/compal_e88.c **** 		break;
 220:battery/compal_e88.c **** 	default:
 221:battery/compal_e88.c **** 	case CHARG_FAIL:
 222:battery/compal_e88.c **** 		if(bat_compal_e88_madc[MADC_VBAT] < VBAT_full)
 223:battery/compal_e88.c **** 			bat_compal_e88_goto_state(CHARG_CONST_CURR);
 224:battery/compal_e88.c **** 		break;
 225:battery/compal_e88.c **** 	}
 226:battery/compal_e88.c **** }
 227:battery/compal_e88.c **** 
 228:battery/compal_e88.c **** /*
 229:battery/compal_e88.c ****  * Charging voltage connection - state machine, remembers
 230:battery/compal_e88.c ****  * state in battery_info.flags.
 231:battery/compal_e88.c ****  *
 232:battery/compal_e88.c ****  *                     VCHG > VCHG_thr_on
 233:battery/compal_e88.c ****  * +-----------------+ ------------------> +---------------+
 234:battery/compal_e88.c ****  * | ! CHG_CONNECTED |                     | CHG_CONNECTED |
 235:battery/compal_e88.c ****  * +-----------------+ <------------------ +---------------+
 236:battery/compal_e88.c ****  *                     VCHG < VCHG_thr_off
 237:battery/compal_e88.c ****  */
 238:battery/compal_e88.c **** static void
 239:battery/compal_e88.c **** bat_compal_e88_chk_ac_presence(){
 240:battery/compal_e88.c **** 	int vrpcsts = twl3025_reg_read(VRPCSTS);
 241:battery/compal_e88.c **** 
 242:battery/compal_e88.c **** 	/* check for presence of charging voltage */
 243:battery/compal_e88.c **** 	if(!(battery_info.flags & BATTERY_CHG_CONNECTED)){
 244:battery/compal_e88.c **** 		if(vrpcsts & CHGPRES){
 245:battery/compal_e88.c **** 			puts("\033[34;1mCHARGER: external voltage connected!\033[0m\n");
 246:battery/compal_e88.c **** 			battery_info.flags |= BATTERY_CHG_CONNECTED;
 247:battery/compal_e88.c **** 
 248:battery/compal_e88.c **** 			/* always keep ADC, voltage dividers and bias voltages on */
 249:battery/compal_e88.c **** 			twl3025_unit_enable(TWL3025_UNIT_MAD,1);
 250:battery/compal_e88.c **** 			twl3025_reg_write(BCICTL1,BATTERY_ALL_SENSE);
 251:battery/compal_e88.c **** 		}
 252:battery/compal_e88.c **** 	} else {
 253:battery/compal_e88.c **** 		if(!(vrpcsts & CHGPRES)){
 254:battery/compal_e88.c **** 			/* we'll only run ADC on demand */
 255:battery/compal_e88.c **** 			twl3025_unit_enable(TWL3025_UNIT_MAD,0);
 256:battery/compal_e88.c **** 			twl3025_reg_write(BCICTL1,0);
 257:battery/compal_e88.c **** 
 258:battery/compal_e88.c **** 			battery_info.flags &= ~ BATTERY_CHG_CONNECTED;
 259:battery/compal_e88.c **** 			puts("\033[34;1mCHARGER: external voltage disconnected!\033[0m\n");
 260:battery/compal_e88.c **** 		}
 261:battery/compal_e88.c **** 	}
 262:battery/compal_e88.c **** }
 263:battery/compal_e88.c **** 
 264:battery/compal_e88.c **** /* ---- update voltages visible to the user ---- */
 265:battery/compal_e88.c **** static void
 266:battery/compal_e88.c **** bat_compal_e88_upd_measurements(){
 267:battery/compal_e88.c **** 	int adc,i;
 268:battery/compal_e88.c **** 
 269:battery/compal_e88.c **** 	battery_info.charger_volt_mV=
 270:battery/compal_e88.c **** 		ADC_TO_PHYSICAL(bat_compal_e88_madc[MADC_VCHG],VCHG_LSB_uV);
 271:battery/compal_e88.c **** 	battery_info.bat_volt_mV=
 272:battery/compal_e88.c **** 		ADC_TO_PHYSICAL(bat_compal_e88_madc[MADC_VBAT],VBAT_LSB_uV);
 273:battery/compal_e88.c **** 	battery_info.bat_chg_curr_mA=
 274:battery/compal_e88.c **** 		ADC_TO_PHYSICAL(bat_compal_e88_madc[MADC_ICHG],ICHG_LSB_uA);
 275:battery/compal_e88.c **** 
 276:battery/compal_e88.c **** 	adc = bat_compal_e88_madc[MADC_VBAT];
 277:battery/compal_e88.c **** 	if(adc <= VBAT_empty){			/* battery 0..100% */
 278:battery/compal_e88.c **** 		battery_info.battery_percent = 0;
 279:battery/compal_e88.c **** 	} else if (adc >= VBAT_full){
 280:battery/compal_e88.c **** 		battery_info.battery_percent = 100;
 281:battery/compal_e88.c **** 	} else {
 282:battery/compal_e88.c **** 		battery_info.battery_percent =
 283:battery/compal_e88.c **** 			(50+100*(adc-VBAT_empty))/(VBAT_full-VBAT_empty);
 284:battery/compal_e88.c **** 	}
 285:battery/compal_e88.c **** 
 286:battery/compal_e88.c ****         /* DEBUG */
 287:battery/compal_e88.c ****         printf("BAT-ADC: ");
 288:battery/compal_e88.c ****         for(i=0;i<MADC_NUM_CHANNELS;i++)
 289:battery/compal_e88.c ****                 printf("%3d ",bat_compal_e88_madc[i]);
 290:battery/compal_e88.c ****         printf("%c\n",32);
 291:battery/compal_e88.c ****         printf("\tCharger at %u mV.\n",battery_info.charger_volt_mV);
 292:battery/compal_e88.c ****         printf("\tBattery at %u mV.\n",battery_info.bat_volt_mV);
 293:battery/compal_e88.c ****         printf("\tCharging at %u mA.\n",battery_info.bat_chg_curr_mA);
 294:battery/compal_e88.c ****         printf("\tBattery capacity is %u%%.\n",battery_info.battery_percent);
 295:battery/compal_e88.c **** 	printf("\tBattery range is %d..%d mV.\n",
 296:battery/compal_e88.c **** 		ADC_TO_PHYSICAL(VBAT_empty,VBAT_LSB_uV),
 297:battery/compal_e88.c **** 		ADC_TO_PHYSICAL(VBAT_full,VBAT_LSB_uV));
 298:battery/compal_e88.c ****         printf("\tBattery full at %d LSB .. full at %d LSB\n",VBAT_empty,VBAT_full);
 299:battery/compal_e88.c ****         printf("\tCharging at %d LSB (%d mA).\n",ICHG_set,
 300:battery/compal_e88.c ****                 ADC_TO_PHYSICAL(ICHG_set,ICHG_LSB_uA));
 301:battery/compal_e88.c ****         i = twl3025_reg_read(BCICTL2);
 302:battery/compal_e88.c ****         printf("\tBCICTL2=0x%03x\n",i);      
 303:battery/compal_e88.c **** 	printf("\tbattery-info.flags=0x%08x\n",battery_info.flags);
 304:battery/compal_e88.c **** 	printf("\tbat_compal_e88_chg_state=%d\n",bat_compal_e88_chg_state);
 305:battery/compal_e88.c **** }
 306:battery/compal_e88.c **** 
 307:battery/compal_e88.c **** /* bat_compal_e88_adc_read() :
 308:battery/compal_e88.c ****  *
 309:battery/compal_e88.c ****  * Schedule a ADC conversion or read values from ADC. If we are
 310:battery/compal_e88.c ****  * running on battery, bias currents/voltage dividers are turned
 311:battery/compal_e88.c ****  * on on demand.
 312:battery/compal_e88.c ****  *
 313:battery/compal_e88.c ****  * Return 0 if new ADC values have been acquired, 1 if ADC
 314:battery/compal_e88.c ****  * has been scheduled for a new conversion or is not yet finished.
 315:battery/compal_e88.c ****  * 
 316:battery/compal_e88.c ****  */
 317:battery/compal_e88.c **** 
 318:battery/compal_e88.c **** enum bat_compal_e88_madc_stat {
 319:battery/compal_e88.c **** 	ADC_CONVERSION = 1 << 0
 320:battery/compal_e88.c **** };
 321:battery/compal_e88.c **** static uint32_t bat_compal_e88_madc_stat=0;
 322:battery/compal_e88.c **** 
 323:battery/compal_e88.c **** static int
 324:battery/compal_e88.c **** bat_compal_e88_adc_read(){
 325:battery/compal_e88.c **** 	int i;
 326:battery/compal_e88.c **** 
 327:battery/compal_e88.c **** 	if(bat_compal_e88_madc_stat & ADC_CONVERSION){
 328:battery/compal_e88.c **** 		i = twl3025_reg_read(MADCSTAT);
 329:battery/compal_e88.c **** 		if(i & ADCBUSY)
 330:battery/compal_e88.c **** 			return 1;
 331:battery/compal_e88.c **** 		for(i=0;i<MADC_NUM_CHANNELS;i++)
 332:battery/compal_e88.c **** 			bat_compal_e88_madc[i]=twl3025_reg_read(VBATREG+i);
 333:battery/compal_e88.c **** 		/* if charger is connected, we keep the ADC and BIAS on
 334:battery/compal_e88.c **** 		   continuously, if running on battery, we try to save power */
 335:battery/compal_e88.c **** 		if(!(battery_info.flags & BATTERY_CHG_CONNECTED)){
 336:battery/compal_e88.c **** 			twl3025_reg_write(BCICTL1,0x00); /* turn off bias */
 337:battery/compal_e88.c **** 			twl3025_unit_enable(TWL3025_UNIT_MAD,0); /* & ADC */
 338:battery/compal_e88.c **** 		}
 339:battery/compal_e88.c **** 		bat_compal_e88_madc_stat &= ~ ADC_CONVERSION;
 340:battery/compal_e88.c **** 		return 0;
 341:battery/compal_e88.c **** 	} else {
 342:battery/compal_e88.c **** 		/* if running on battery, turn on ADC & BIAS on demand */
 343:battery/compal_e88.c **** 		if(!(battery_info.flags & BATTERY_CHG_CONNECTED)){
 344:battery/compal_e88.c **** 			twl3025_unit_enable(TWL3025_UNIT_MAD,1);
 345:battery/compal_e88.c **** 			twl3025_reg_write(BCICTL1,BATTERY_ALL_SENSE);
 346:battery/compal_e88.c **** 		}
 347:battery/compal_e88.c **** 
 348:battery/compal_e88.c **** 		twl3025_reg_write(MADCTRL,0xff); /* convert all channels */
 349:battery/compal_e88.c **** 		twl3025_reg_write(VBATREG,0);    /* trigger conversion */
 350:battery/compal_e88.c **** 
 351:battery/compal_e88.c **** 		bat_compal_e88_madc_stat |= ADC_CONVERSION;
 352:battery/compal_e88.c **** 		return 1;
 353:battery/compal_e88.c **** 	}
 354:battery/compal_e88.c **** }
 355:battery/compal_e88.c **** 
 356:battery/compal_e88.c **** static void
 357:battery/compal_e88.c **** battery_compal_e88_timer_cb(void *p){
 151              		.loc 1 357 0
 152              		.cfi_startproc
 153              		@ args = 0, pretend = 0, frame = 0
 154              		@ frame_needed = 0, uses_anonymous_args = 0
 155              	.LVL2:
 156              	.LBB14:
 157              	.LBB16:
 327:battery/compal_e88.c **** 	if(bat_compal_e88_madc_stat & ADC_CONVERSION){
 158              		.loc 1 327 0
 159 0000 3C339FE5 		ldr	r3, .L42
 160 0004 043093E5 		ldr	r3, [r3, #4]
 161 0008 010013E3 		tst	r3, #1
 162              	.LBE16:
 163              	.LBE14:
 164              		.loc 1 357 0
 165 000c F0412DE9 		stmfd	sp!, {r4, r5, r6, r7, r8, lr}
 166              	.LCFI1:
 167              		.cfi_def_cfa_offset 24
 168              		.loc 1 357 0
 169 0010 0050A0E1 		mov	r5, r0
 170              		.cfi_offset 14, -4
 171              		.cfi_offset 8, -8
 172              		.cfi_offset 7, -12
 173              		.cfi_offset 6, -16
 174              		.cfi_offset 5, -20
 175              		.cfi_offset 4, -24
 176              	.LVL3:
 177              	.LBB19:
 178              	.LBB17:
 327:battery/compal_e88.c **** 	if(bat_compal_e88_madc_stat & ADC_CONVERSION){
 179              		.loc 1 327 0
 180 0014 3500000A 		beq	.L13
 181              	.LVL4:
 328:battery/compal_e88.c **** 		i = twl3025_reg_read(MADCSTAT);
 182              		.loc 1 328 0
 183 0018 1800A0E3 		mov	r0, #24
 184              	.LVL5:
 185 001c FEFFFFEB 		bl	twl3025_reg_read
 186              	.LVL6:
 329:battery/compal_e88.c **** 		if(i & ADCBUSY)
 187              		.loc 1 329 0
 188 0020 010010E3 		tst	r0, #1
 189 0024 4500001A 		bne	.L14
 190 0028 18639FE5 		ldr	r6, .L42+4
 191 002c 0F40A0E3 		mov	r4, #15
 192 0030 0670A0E1 		mov	r7, r6
 193              	.LVL7:
 194              	.L15:
 332:battery/compal_e88.c **** 			bat_compal_e88_madc[i]=twl3025_reg_read(VBATREG+i);
 195              		.loc 1 332 0
 196 0034 0400A0E1 		mov	r0, r4
 197 0038 FEFFFFEB 		bl	twl3025_reg_read
 198 003c 014084E2 		add	r4, r4, #1
 331:battery/compal_e88.c **** 		for(i=0;i<MADC_NUM_CHANNELS;i++)
 199              		.loc 1 331 0
 200 0040 170054E3 		cmp	r4, #23
 332:battery/compal_e88.c **** 			bat_compal_e88_madc[i]=twl3025_reg_read(VBATREG+i);
 201              		.loc 1 332 0
 202 0044 B200E7E1 		strh	r0, [r7, #2]!	@ movhi
 331:battery/compal_e88.c **** 		for(i=0;i<MADC_NUM_CHANNELS;i++)
 203              		.loc 1 331 0
 204 0048 F9FFFF1A 		bne	.L15
 335:battery/compal_e88.c **** 		if(!(battery_info.flags & BATTERY_CHG_CONNECTED)){
 205              		.loc 1 335 0
 206 004c F8329FE5 		ldr	r3, .L42+8
 207 0050 004093E5 		ldr	r4, [r3, #0]
 208 0054 014014E2 		ands	r4, r4, #1
 209 0058 0500001A 		bne	.L16
 336:battery/compal_e88.c **** 			twl3025_reg_write(BCICTL1,0x00); /* turn off bias */
 210              		.loc 1 336 0
 211 005c 1C00A0E3 		mov	r0, #28
 212 0060 0410A0E1 		mov	r1, r4
 213 0064 FEFFFFEB 		bl	twl3025_reg_write
 337:battery/compal_e88.c **** 			twl3025_unit_enable(TWL3025_UNIT_MAD,0); /* & ADC */
 214              		.loc 1 337 0
 215 0068 0100A0E3 		mov	r0, #1
 216 006c 0410A0E1 		mov	r1, r4
 217 0070 FEFFFFEB 		bl	twl3025_unit_enable
 218              	.L16:
 339:battery/compal_e88.c **** 		bat_compal_e88_madc_stat &= ~ ADC_CONVERSION;
 219              		.loc 1 339 0
 220 0074 C8329FE5 		ldr	r3, .L42
 221 0078 042093E5 		ldr	r2, [r3, #4]
 222              	.LBE17:
 223              	.LBE19:
 224              	.LBB20:
 225              	.LBB22:
 270:battery/compal_e88.c **** 		ADC_TO_PHYSICAL(bat_compal_e88_madc[MADC_VCHG],VCHG_LSB_uV);
 226              		.loc 1 270 0
 227 007c CC829FE5 		ldr	r8, .L42+12
 228              	.LBE22:
 229              	.LBE20:
 230              	.LBB24:
 231              	.LBB15:
 339:battery/compal_e88.c **** 		bat_compal_e88_madc_stat &= ~ ADC_CONVERSION;
 232              		.loc 1 339 0
 233 0080 0120C2E3 		bic	r2, r2, #1
 234 0084 042083E5 		str	r2, [r3, #4]
 235              	.LBE15:
 236              	.LBE24:
 237              	.LBB25:
 238              	.LBB21:
 270:battery/compal_e88.c **** 		ADC_TO_PHYSICAL(bat_compal_e88_madc[MADC_VCHG],VCHG_LSB_uV);
 239              		.loc 1 270 0
 240 0088 C4029FE5 		ldr	r0, .L42+16
 241 008c B230D8E1 		ldrh	r3, [r8, #2]
 242 0090 930000E0 		mul	r0, r3, r0
 243 0094 FA1FA0E3 		mov	r1, #1000
 244 0098 7D0F80E2 		add	r0, r0, #500
 245 009c FEFFFFEB 		bl	__divsi3
 269:battery/compal_e88.c **** 	battery_info.charger_volt_mV=
 246              		.loc 1 269 0
 247 00a0 A4429FE5 		ldr	r4, .L42+8
 272:battery/compal_e88.c **** 		ADC_TO_PHYSICAL(bat_compal_e88_madc[MADC_VBAT],VBAT_LSB_uV);
 248              		.loc 1 272 0
 249 00a4 B070D8E1 		ldrh	r7, [r8, #0]
 269:battery/compal_e88.c **** 	battery_info.charger_volt_mV=
 250              		.loc 1 269 0
 251 00a8 040084E5 		str	r0, [r4, #4]
 272:battery/compal_e88.c **** 		ADC_TO_PHYSICAL(bat_compal_e88_madc[MADC_VBAT],VBAT_LSB_uV);
 252              		.loc 1 272 0
 253 00ac A4029FE5 		ldr	r0, .L42+20
 254 00b0 970000E0 		mul	r0, r7, r0
 255 00b4 FA1FA0E3 		mov	r1, #1000
 256 00b8 7D0F80E2 		add	r0, r0, #500
 257 00bc FEFFFFEB 		bl	__divsi3
 274:battery/compal_e88.c **** 		ADC_TO_PHYSICAL(bat_compal_e88_madc[MADC_ICHG],ICHG_LSB_uA);
 258              		.loc 1 274 0
 259 00c0 B430D8E1 		ldrh	r3, [r8, #4]
 271:battery/compal_e88.c **** 	battery_info.bat_volt_mV=
 260              		.loc 1 271 0
 261 00c4 080084E5 		str	r0, [r4, #8]
 274:battery/compal_e88.c **** 		ADC_TO_PHYSICAL(bat_compal_e88_madc[MADC_ICHG],ICHG_LSB_uA);
 262              		.loc 1 274 0
 263 00c8 8C029FE5 		ldr	r0, .L42+24
 264 00cc 930000E0 		mul	r0, r3, r0
 265 00d0 FA1FA0E3 		mov	r1, #1000
 266 00d4 7D0F80E2 		add	r0, r0, #500
 267 00d8 FEFFFFEB 		bl	__divsi3
 277:battery/compal_e88.c **** 	if(adc <= VBAT_empty){			/* battery 0..100% */
 268              		.loc 1 277 0
 269 00dc 750F57E3 		cmp	r7, #468
 273:battery/compal_e88.c **** 	battery_info.bat_chg_curr_mA=
 270              		.loc 1 273 0
 271 00e0 0C0084E5 		str	r0, [r4, #12]
 272              	.LVL8:
 278:battery/compal_e88.c **** 		battery_info.battery_percent = 0;
 273              		.loc 1 278 0
 274 00e4 0030A0D3 		movle	r3, #0
 277:battery/compal_e88.c **** 	if(adc <= VBAT_empty){			/* battery 0..100% */
 275              		.loc 1 277 0
 276 00e8 1A0000DA 		ble	.L36
 277 00ec 160000EA 		b	.L41
 278              	.LVL9:
 279              	.L13:
 280              	.LBE21:
 281              	.LBE25:
 282              	.LBB26:
 283              	.LBB18:
 343:battery/compal_e88.c **** 		if(!(battery_info.flags & BATTERY_CHG_CONNECTED)){
 284              		.loc 1 343 0
 285 00f0 54329FE5 		ldr	r3, .L42+8
 286 00f4 003093E5 		ldr	r3, [r3, #0]
 287 00f8 010013E3 		tst	r3, #1
 288 00fc 0500001A 		bne	.L19
 344:battery/compal_e88.c **** 			twl3025_unit_enable(TWL3025_UNIT_MAD,1);
 289              		.loc 1 344 0
 290 0100 0100A0E3 		mov	r0, #1
 291 0104 0010A0E1 		mov	r1, r0
 292 0108 FEFFFFEB 		bl	twl3025_unit_enable
 345:battery/compal_e88.c **** 			twl3025_reg_write(BCICTL1,BATTERY_ALL_SENSE);
 293              		.loc 1 345 0
 294 010c 1C00A0E3 		mov	r0, #28
 295 0110 F910A0E3 		mov	r1, #249
 296 0114 FEFFFFEB 		bl	twl3025_reg_write
 297              	.L19:
 348:battery/compal_e88.c **** 		twl3025_reg_write(MADCTRL,0xff); /* convert all channels */
 298              		.loc 1 348 0
 299 0118 0D00A0E3 		mov	r0, #13
 300 011c FF10A0E3 		mov	r1, #255
 301 0120 FEFFFFEB 		bl	twl3025_reg_write
 349:battery/compal_e88.c **** 		twl3025_reg_write(VBATREG,0);    /* trigger conversion */
 302              		.loc 1 349 0
 303 0124 0F00A0E3 		mov	r0, #15
 304 0128 0010A0E3 		mov	r1, #0
 305 012c FEFFFFEB 		bl	twl3025_reg_write
 351:battery/compal_e88.c **** 		bat_compal_e88_madc_stat |= ADC_CONVERSION;
 306              		.loc 1 351 0
 307 0130 0C329FE5 		ldr	r3, .L42
 308 0134 042093E5 		ldr	r2, [r3, #4]
 309 0138 012082E3 		orr	r2, r2, #1
 310 013c 042083E5 		str	r2, [r3, #4]
 311              	.L14:
 312              	.LBE18:
 313              	.LBE26:
 358:battery/compal_e88.c **** 	struct osmo_timer_list *tmr = (struct osmo_timer_list*)p;
 359:battery/compal_e88.c **** 	int i;
 360:battery/compal_e88.c **** 
 361:battery/compal_e88.c **** 	if(bat_compal_e88_adc_read()){ /* read back ADCs after a brief delay */
 362:battery/compal_e88.c **** 		osmo_timer_schedule(tmr,ADC_TIMER_DELAY);
 314              		.loc 1 362 0
 315 0140 0500A0E1 		mov	r0, r5
 316 0144 6410A0E3 		mov	r1, #100
 317 0148 7B0000EA 		b	.L38
 318              	.LVL10:
 319              	.L41:
 320              	.LBB27:
 321              	.LBB23:
 279:battery/compal_e88.c **** 	} else if (adc >= VBAT_full){
 322              		.loc 1 279 0
 323 014c 920F57E3 		cmp	r7, #584
 324 0150 020000DA 		ble	.L21
 280:battery/compal_e88.c **** 		battery_info.battery_percent = 100;
 325              		.loc 1 280 0
 326 0154 6430A0E3 		mov	r3, #100
 327              	.L36:
 328 0158 103084E5 		str	r3, [r4, #16]
 329 015c 060000EA 		b	.L20
 330              	.L21:
 283:battery/compal_e88.c **** 			(50+100*(adc-VBAT_empty))/(VBAT_full-VBAT_empty);
 331              		.loc 1 283 0
 332 0160 6430A0E3 		mov	r3, #100
 333 0164 930707E0 		mul	r7, r3, r7
 334              	.LVL11:
 335 0168 B60C47E2 		sub	r0, r7, #46592
 336 016c 9E0040E2 		sub	r0, r0, #158
 337 0170 7510A0E3 		mov	r1, #117
 338 0174 FEFFFFEB 		bl	__divsi3
 282:battery/compal_e88.c **** 		battery_info.battery_percent =
 339              		.loc 1 282 0
 340 0178 100084E5 		str	r0, [r4, #16]
 341              	.L20:
 287:battery/compal_e88.c ****         printf("BAT-ADC: ");
 342              		.loc 1 287 0
 343 017c DC019FE5 		ldr	r0, .L42+28
 344 0180 FEFFFFEB 		bl	printf
 345              	.LVL12:
 357:battery/compal_e88.c **** battery_compal_e88_timer_cb(void *p){
 346              		.loc 1 357 0
 347 0184 D8419FE5 		ldr	r4, .L42+32
 348              	.LVL13:
 349              	.L22:
 289:battery/compal_e88.c ****                 printf("%3d ",bat_compal_e88_madc[i]);
 350              		.loc 1 289 0
 351 0188 B210F6E1 		ldrh	r1, [r6, #2]!
 352 018c D4019FE5 		ldr	r0, .L42+36
 353 0190 FEFFFFEB 		bl	printf
 288:battery/compal_e88.c ****         for(i=0;i<MADC_NUM_CHANNELS;i++)
 354              		.loc 1 288 0
 355 0194 040056E1 		cmp	r6, r4
 356 0198 FAFFFF1A 		bne	.L22
 291:battery/compal_e88.c ****         printf("\tCharger at %u mV.\n",battery_info.charger_volt_mV);
 357              		.loc 1 291 0
 358 019c A8419FE5 		ldr	r4, .L42+8
 290:battery/compal_e88.c ****         printf("%c\n",32);
 359              		.loc 1 290 0
 360 01a0 2010A0E3 		mov	r1, #32
 361 01a4 C0019FE5 		ldr	r0, .L42+40
 362 01a8 FEFFFFEB 		bl	printf
 291:battery/compal_e88.c ****         printf("\tCharger at %u mV.\n",battery_info.charger_volt_mV);
 363              		.loc 1 291 0
 364 01ac 041094E5 		ldr	r1, [r4, #4]
 365 01b0 B8019FE5 		ldr	r0, .L42+44
 366 01b4 FEFFFFEB 		bl	printf
 292:battery/compal_e88.c ****         printf("\tBattery at %u mV.\n",battery_info.bat_volt_mV);
 367              		.loc 1 292 0
 368 01b8 081094E5 		ldr	r1, [r4, #8]
 369 01bc B0019FE5 		ldr	r0, .L42+48
 370 01c0 FEFFFFEB 		bl	printf
 293:battery/compal_e88.c ****         printf("\tCharging at %u mA.\n",battery_info.bat_chg_curr_mA);
 371              		.loc 1 293 0
 372 01c4 0C1094E5 		ldr	r1, [r4, #12]
 373 01c8 A8019FE5 		ldr	r0, .L42+52
 374 01cc FEFFFFEB 		bl	printf
 294:battery/compal_e88.c ****         printf("\tBattery capacity is %u%%.\n",battery_info.battery_percent);
 375              		.loc 1 294 0
 376 01d0 101094E5 		ldr	r1, [r4, #16]
 377 01d4 A0019FE5 		ldr	r0, .L42+56
 378 01d8 FEFFFFEB 		bl	printf
 295:battery/compal_e88.c **** 	printf("\tBattery range is %d..%d mV.\n",
 379              		.loc 1 295 0
 380 01dc 9C119FE5 		ldr	r1, .L42+60
 381 01e0 9C219FE5 		ldr	r2, .L42+64
 382 01e4 9C019FE5 		ldr	r0, .L42+68
 383 01e8 FEFFFFEB 		bl	printf
 298:battery/compal_e88.c ****         printf("\tBattery full at %d LSB .. full at %d LSB\n",VBAT_empty,VBAT_full);
 384              		.loc 1 298 0
 385 01ec 751FA0E3 		mov	r1, #468
 386 01f0 94219FE5 		ldr	r2, .L42+72
 387 01f4 94019FE5 		ldr	r0, .L42+76
 388 01f8 FEFFFFEB 		bl	printf
 299:battery/compal_e88.c ****         printf("\tCharging at %d LSB (%d mA).\n",ICHG_set,
 389              		.loc 1 299 0
 390 01fc CC20A0E3 		mov	r2, #204
 391 0200 EF10A0E3 		mov	r1, #239
 392 0204 88019FE5 		ldr	r0, .L42+80
 393 0208 FEFFFFEB 		bl	printf
 301:battery/compal_e88.c ****         i = twl3025_reg_read(BCICTL2);
 394              		.loc 1 301 0
 395 020c 1D00A0E3 		mov	r0, #29
 396 0210 FEFFFFEB 		bl	twl3025_reg_read
 397 0214 0010A0E1 		mov	r1, r0
 398              	.LVL14:
 302:battery/compal_e88.c ****         printf("\tBCICTL2=0x%03x\n",i);      
 399              		.loc 1 302 0
 400 0218 78019FE5 		ldr	r0, .L42+84
 401              	.LVL15:
 402 021c FEFFFFEB 		bl	printf
 403              	.LVL16:
 303:battery/compal_e88.c **** 	printf("\tbattery-info.flags=0x%08x\n",battery_info.flags);
 404              		.loc 1 303 0
 405 0220 001094E5 		ldr	r1, [r4, #0]
 406 0224 70019FE5 		ldr	r0, .L42+88
 407 0228 FEFFFFEB 		bl	printf
 304:battery/compal_e88.c **** 	printf("\tbat_compal_e88_chg_state=%d\n",bat_compal_e88_chg_state);
 408              		.loc 1 304 0
 409 022c 10319FE5 		ldr	r3, .L42
 410 0230 68019FE5 		ldr	r0, .L42+92
 411 0234 001093E5 		ldr	r1, [r3, #0]
 412 0238 FEFFFFEB 		bl	printf
 413              	.LBE23:
 414              	.LBE27:
 415              	.LBB28:
 416              	.LBB29:
 240:battery/compal_e88.c **** 	int vrpcsts = twl3025_reg_read(VRPCSTS);
 417              		.loc 1 240 0
 418 023c 1F00A0E3 		mov	r0, #31
 419 0240 FEFFFFEB 		bl	twl3025_reg_read
 420              	.LVL17:
 243:battery/compal_e88.c **** 	if(!(battery_info.flags & BATTERY_CHG_CONNECTED)){
 421              		.loc 1 243 0
 422 0244 003094E5 		ldr	r3, [r4, #0]
 423 0248 010013E3 		tst	r3, #1
 424 024c 406000E2 		and	r6, r0, #64
 425 0250 0D00001A 		bne	.L23
 244:battery/compal_e88.c **** 		if(vrpcsts & CHGPRES){
 426              		.loc 1 244 0
 427 0254 000056E3 		cmp	r6, #0
 428 0258 1800000A 		beq	.L24
 245:battery/compal_e88.c **** 			puts("\033[34;1mCHARGER: external voltage connected!\033[0m\n");
 429              		.loc 1 245 0
 430 025c 40019FE5 		ldr	r0, .L42+96
 431              	.LVL18:
 432 0260 FEFFFFEB 		bl	puts
 246:battery/compal_e88.c **** 			battery_info.flags |= BATTERY_CHG_CONNECTED;
 433              		.loc 1 246 0
 434 0264 003094E5 		ldr	r3, [r4, #0]
 249:battery/compal_e88.c **** 			twl3025_unit_enable(TWL3025_UNIT_MAD,1);
 435              		.loc 1 249 0
 436 0268 0100A0E3 		mov	r0, #1
 246:battery/compal_e88.c **** 			battery_info.flags |= BATTERY_CHG_CONNECTED;
 437              		.loc 1 246 0
 438 026c 013083E3 		orr	r3, r3, #1
 249:battery/compal_e88.c **** 			twl3025_unit_enable(TWL3025_UNIT_MAD,1);
 439              		.loc 1 249 0
 440 0270 0010A0E1 		mov	r1, r0
 246:battery/compal_e88.c **** 			battery_info.flags |= BATTERY_CHG_CONNECTED;
 441              		.loc 1 246 0
 442 0274 003084E5 		str	r3, [r4, #0]
 249:battery/compal_e88.c **** 			twl3025_unit_enable(TWL3025_UNIT_MAD,1);
 443              		.loc 1 249 0
 444 0278 FEFFFFEB 		bl	twl3025_unit_enable
 250:battery/compal_e88.c **** 			twl3025_reg_write(BCICTL1,BATTERY_ALL_SENSE);
 445              		.loc 1 250 0
 446 027c 1C00A0E3 		mov	r0, #28
 447 0280 F910A0E3 		mov	r1, #249
 448 0284 FEFFFFEB 		bl	twl3025_reg_write
 449 0288 0C0000EA 		b	.L24
 450              	.LVL19:
 451              	.L23:
 253:battery/compal_e88.c **** 		if(!(vrpcsts & CHGPRES)){
 452              		.loc 1 253 0
 453 028c 000056E3 		cmp	r6, #0
 454 0290 0A00001A 		bne	.L24
 255:battery/compal_e88.c **** 			twl3025_unit_enable(TWL3025_UNIT_MAD,0);
 455              		.loc 1 255 0
 456 0294 0100A0E3 		mov	r0, #1
 457              	.LVL20:
 458 0298 0610A0E1 		mov	r1, r6
 459 029c FEFFFFEB 		bl	twl3025_unit_enable
 256:battery/compal_e88.c **** 			twl3025_reg_write(BCICTL1,0);
 460              		.loc 1 256 0
 461 02a0 1C00A0E3 		mov	r0, #28
 462 02a4 0610A0E1 		mov	r1, r6
 463 02a8 FEFFFFEB 		bl	twl3025_reg_write
 258:battery/compal_e88.c **** 			battery_info.flags &= ~ BATTERY_CHG_CONNECTED;
 464              		.loc 1 258 0
 465 02ac 003094E5 		ldr	r3, [r4, #0]
 466 02b0 0130C3E3 		bic	r3, r3, #1
 467 02b4 003084E5 		str	r3, [r4, #0]
 259:battery/compal_e88.c **** 			puts("\033[34;1mCHARGER: external voltage disconnected!\033[0m\n");
 468              		.loc 1 259 0
 469 02b8 E8009FE5 		ldr	r0, .L42+100
 470 02bc FEFFFFEB 		bl	puts
 471              	.L24:
 472              	.LBE29:
 473              	.LBE28:
 474              	.LBB30:
 475              	.LBB31:
 194:battery/compal_e88.c **** 	if(!(battery_info.flags & BATTERY_CHG_CONNECTED)){
 476              		.loc 1 194 0
 477 02c0 84309FE5 		ldr	r3, .L42+8
 478 02c4 000093E5 		ldr	r0, [r3, #0]
 479 02c8 010010E2 		ands	r0, r0, #1
 480 02cc 1700000A 		beq	.L37
 481              	.L25:
 200:battery/compal_e88.c **** 	if(bat_compal_e88_madc[MADC_VBAT] > VBAT_fail){
 482              		.loc 1 200 0
 483 02d0 78309FE5 		ldr	r3, .L42+12
 484 02d4 D0209FE5 		ldr	r2, .L42+104
 485 02d8 B030D3E1 		ldrh	r3, [r3, #0]
 486 02dc 020053E1 		cmp	r3, r2
 201:battery/compal_e88.c **** 		bat_compal_e88_goto_state(CHARG_FAIL);
 487              		.loc 1 201 0
 488 02e0 0300A083 		movhi	r0, #3
 200:battery/compal_e88.c **** 	if(bat_compal_e88_madc[MADC_VBAT] > VBAT_fail){
 489              		.loc 1 200 0
 490 02e4 1100008A 		bhi	.L37
 207:battery/compal_e88.c **** 	switch(bat_compal_e88_chg_state){
 491              		.loc 1 207 0
 492 02e8 54209FE5 		ldr	r2, .L42
 493 02ec 002092E5 		ldr	r2, [r2, #0]
 494 02f0 010052E3 		cmp	r2, #1
 495 02f4 0600000A 		beq	.L30
 496 02f8 0200003A 		bcc	.L29
 497 02fc 020052E3 		cmp	r2, #2
 498 0300 0700001A 		bne	.L35
 499 0304 0A0000EA 		b	.L26
 500              	.L29:
 209:battery/compal_e88.c **** 		if(bat_compal_e88_madc[MADC_VBAT] >= VBAT_full)
 501              		.loc 1 209 0
 502 0308 920F53E3 		cmp	r3, #584
 503 030c 0600009A 		bls	.L40
 504 0310 010000EA 		b	.L39
 505              	.L30:
 215:battery/compal_e88.c **** 		if(bat_compal_e88_madc[MADC_VBAT] >= VBAT_full)
 506              		.loc 1 215 0
 507 0314 920F53E3 		cmp	r3, #584
 508 0318 0500009A 		bls	.L26
 509              	.L39:
 216:battery/compal_e88.c **** 			bat_compal_e88_goto_state(CHARG_CONST_VOLT);
 510              		.loc 1 216 0
 511 031c 0200A0E3 		mov	r0, #2
 512 0320 020000EA 		b	.L37
 513              	.L35:
 222:battery/compal_e88.c **** 		if(bat_compal_e88_madc[MADC_VBAT] < VBAT_full)
 514              		.loc 1 222 0
 515 0324 920F53E3 		cmp	r3, #584
 516 0328 0100008A 		bhi	.L26
 517              	.L40:
 223:battery/compal_e88.c **** 			bat_compal_e88_goto_state(CHARG_CONST_CURR);
 518              		.loc 1 223 0
 519 032c 0100A0E3 		mov	r0, #1
 520              	.L37:
 521 0330 FEFFFFEB 		bl	bat_compal_e88_goto_state
 522              	.L26:
 523              	.LBE31:
 524              	.LBE30:
 363:battery/compal_e88.c **** 		return;
 364:battery/compal_e88.c **** 	}
 365:battery/compal_e88.c **** 
 366:battery/compal_e88.c **** 	bat_compal_e88_upd_measurements();	/* convert user-accessible information */
 367:battery/compal_e88.c **** 	bat_compal_e88_chk_ac_presence();	/* detect AC charger presence */
 368:battery/compal_e88.c **** 	bat_compal_e88_chg_control();	/* battery charger state machine */
 369:battery/compal_e88.c **** 
 370:battery/compal_e88.c **** 	osmo_timer_schedule(tmr,BATTERY_TIMER_DELAY);
 525              		.loc 1 370 0
 526 0334 74109FE5 		ldr	r1, .L42+108
 527 0338 0500A0E1 		mov	r0, r5
 528              	.L38:
 371:battery/compal_e88.c **** }
 529              		.loc 1 371 0
 530 033c F041BDE8 		ldmfd	sp!, {r4, r5, r6, r7, r8, lr}
 370:battery/compal_e88.c **** 	osmo_timer_schedule(tmr,BATTERY_TIMER_DELAY);
 531              		.loc 1 370 0
 532 0340 FEFFFFEA 		b	osmo_timer_schedule
 533              	.L43:
 534              		.align	2
 535              	.L42:
 536 0344 00000000 		.word	.LANCHOR0
 537 0348 FEFFFFFF 		.word	bat_compal_e88_madc-2
 538 034c 00000000 		.word	battery_info
 539 0350 00000000 		.word	bat_compal_e88_madc
 540 0354 61210000 		.word	8545
 541 0358 B41A0000 		.word	6836
 542 035c 56030000 		.word	854
 543 0360 3E000000 		.word	.LC2
 544 0364 0E000000 		.word	bat_compal_e88_madc+14
 545 0368 48000000 		.word	.LC3
 546 036c 4D000000 		.word	.LC4
 547 0370 51000000 		.word	.LC5
 548 0374 65000000 		.word	.LC6
 549 0378 79000000 		.word	.LC7
 550 037c 8E000000 		.word	.LC8
 551 0380 7F0C0000 		.word	3199
 552 0384 9F0F0000 		.word	3999
 553 0388 AA000000 		.word	.LC9
 554 038c 49020000 		.word	585
 555 0390 C8000000 		.word	.LC10
 556 0394 F3000000 		.word	.LC11
 557 0398 11010000 		.word	.LC12
 558 039c 22010000 		.word	.LC13
 559 03a0 3E010000 		.word	.LC14
 560 03a4 5C010000 		.word	.LC15
 561 03a8 8D010000 		.word	.LC16
 562 03ac 6E020000 		.word	622
 563 03b0 88130000 		.word	5000
 564              		.cfi_endproc
 565              	.LFE18:
 567              		.section	.text.battery_compal_e88_init,"ax",%progbits
 568              		.align	2
 569              		.global	battery_compal_e88_init
 571              	battery_compal_e88_init:
 572              	.LFB19:
 372:battery/compal_e88.c **** 
 373:battery/compal_e88.c **** /* timer that fires the charging loop regularly */
 374:battery/compal_e88.c **** static struct osmo_timer_list battery_compal88_timer = {
 375:battery/compal_e88.c **** 	.cb = &battery_compal_e88_timer_cb,
 376:battery/compal_e88.c **** 	.data = &battery_compal88_timer
 377:battery/compal_e88.c **** };
 378:battery/compal_e88.c **** 
 379:battery/compal_e88.c **** void
 380:battery/compal_e88.c **** battery_compal_e88_init(){
 573              		.loc 1 380 0
 574              		.cfi_startproc
 575              		@ args = 0, pretend = 0, frame = 0
 576              		@ frame_needed = 0, uses_anonymous_args = 0
 577 0000 04E02DE5 		str	lr, [sp, #-4]!
 578              	.LCFI2:
 579              		.cfi_def_cfa_offset 4
 381:battery/compal_e88.c **** 	printf("%s: starting up\n",__FUNCTION__);
 580              		.loc 1 381 0
 581 0004 14109FE5 		ldr	r1, .L45
 582 0008 14009FE5 		ldr	r0, .L45+4
 583              		.cfi_offset 14, -4
 584 000c FEFFFFEB 		bl	printf
 382:battery/compal_e88.c **** 	osmo_timer_schedule(&battery_compal88_timer,BATTERY_TIMER_DELAY);
 585              		.loc 1 382 0
 586 0010 10009FE5 		ldr	r0, .L45+8
 587 0014 10109FE5 		ldr	r1, .L45+12
 383:battery/compal_e88.c **** }
 588              		.loc 1 383 0
 589 0018 04E09DE4 		ldr	lr, [sp], #4
 382:battery/compal_e88.c **** 	osmo_timer_schedule(&battery_compal88_timer,BATTERY_TIMER_DELAY);
 590              		.loc 1 382 0
 591 001c FEFFFFEA 		b	osmo_timer_schedule
 592              	.L46:
 593              		.align	2
 594              	.L45:
 595 0020 10000000 		.word	.LANCHOR1+16
 596 0024 C1010000 		.word	.LC17
 597 0028 00000000 		.word	.LANCHOR2
 598 002c 88130000 		.word	5000
 599              		.cfi_endproc
 600              	.LFE19:
 602              		.comm	battery_info,20,4
 603              		.comm	bat_compal_e88_madc,16,4
 604              		.section	.rodata
 605              		.align	2
 606              		.set	.LANCHOR1,. + 0
 609              	bat_compal_e88_chg_state_names:
 610 0000 D2010000 		.word	.LC18
 611 0004 D6010000 		.word	.LC19
 612 0008 E7010000 		.word	.LC20
 613 000c F8010000 		.word	.LC21
 616              	__FUNCTION__.1657:
 617 0010 62617474 		.ascii	"battery_compal_e88_init\000"
 617      6572795F 
 617      636F6D70 
 617      616C5F65 
 617      38385F69 
 618              		.section	.rodata.str1.1,"aMS",%progbits,1
 619              	.LC0:
 620 0000 1B5B3334 		.ascii	"\033[34;1mCHARGER: %s --> %s.\033[0m\012\000"
 620      3B316D43 
 620      48415247 
 620      45523A20 
 620      2573202D 
 621              	.LC1:
 622 0020 42434943 		.ascii	"BCICTL2 is 0x%03x, CHGREG=%d\012\000"
 622      544C3220 
 622      69732030 
 622      78253033 
 622      782C2043 
 623              	.LC2:
 624 003e 4241542D 		.ascii	"BAT-ADC: \000"
 624      4144433A 
 624      2000
 625              	.LC3:
 626 0048 25336420 		.ascii	"%3d \000"
 626      00
 627              	.LC4:
 628 004d 25630A00 		.ascii	"%c\012\000"
 629              	.LC5:
 630 0051 09436861 		.ascii	"\011Charger at %u mV.\012\000"
 630      72676572 
 630      20617420 
 630      2575206D 
 630      562E0A00 
 631              	.LC6:
 632 0065 09426174 		.ascii	"\011Battery at %u mV.\012\000"
 632      74657279 
 632      20617420 
 632      2575206D 
 632      562E0A00 
 633              	.LC7:
 634 0079 09436861 		.ascii	"\011Charging at %u mA.\012\000"
 634      7267696E 
 634      67206174 
 634      20257520 
 634      6D412E0A 
 635              	.LC8:
 636 008e 09426174 		.ascii	"\011Battery capacity is %u%%.\012\000"
 636      74657279 
 636      20636170 
 636      61636974 
 636      79206973 
 637              	.LC9:
 638 00aa 09426174 		.ascii	"\011Battery range is %d..%d mV.\012\000"
 638      74657279 
 638      2072616E 
 638      67652069 
 638      73202564 
 639              	.LC10:
 640 00c8 09426174 		.ascii	"\011Battery full at %d LSB .. full at %d LSB\012\000"
 640      74657279 
 640      2066756C 
 640      6C206174 
 640      20256420 
 641              	.LC11:
 642 00f3 09436861 		.ascii	"\011Charging at %d LSB (%d mA).\012\000"
 642      7267696E 
 642      67206174 
 642      20256420 
 642      4C534220 
 643              	.LC12:
 644 0111 09424349 		.ascii	"\011BCICTL2=0x%03x\012\000"
 644      43544C32 
 644      3D307825 
 644      3033780A 
 644      00
 645              	.LC13:
 646 0122 09626174 		.ascii	"\011battery-info.flags=0x%08x\012\000"
 646      74657279 
 646      2D696E66 
 646      6F2E666C 
 646      6167733D 
 647              	.LC14:
 648 013e 09626174 		.ascii	"\011bat_compal_e88_chg_state=%d\012\000"
 648      5F636F6D 
 648      70616C5F 
 648      6538385F 
 648      6368675F 
 649              	.LC15:
 650 015c 1B5B3334 		.ascii	"\033[34;1mCHARGER: external voltage connected!\033["
 650      3B316D43 
 650      48415247 
 650      45523A20 
 650      65787465 
 651 0189 306D0A00 		.ascii	"0m\012\000"
 652              	.LC16:
 653 018d 1B5B3334 		.ascii	"\033[34;1mCHARGER: external voltage disconnected!\033"
 653      3B316D43 
 653      48415247 
 653      45523A20 
 653      65787465 
 654 01bc 5B306D0A 		.ascii	"[0m\012\000"
 654      00
 655              	.LC17:
 656 01c1 25733A20 		.ascii	"%s: starting up\012\000"
 656      73746172 
 656      74696E67 
 656      2075700A 
 656      00
 657              	.LC18:
 658 01d2 4F666600 		.ascii	"Off\000"
 659              	.LC19:
 660 01d6 436F6E73 		.ascii	"Constant Current\000"
 660      74616E74 
 660      20437572 
 660      72656E74 
 660      00
 661              	.LC20:
 662 01e7 436F6E73 		.ascii	"Constant Voltage\000"
 662      74616E74 
 662      20566F6C 
 662      74616765 
 662      00
 663              	.LC21:
 664 01f8 42617474 		.ascii	"Battery Failure\000"
 664      65727920 
 664      4661696C 
 664      75726500 
 665              		.data
 666              		.align	2
 667              		.set	.LANCHOR2,. + 0
 670              	battery_compal88_timer:
 671 0000 00000000 		.space	16
 671      00000000 
 671      00000000 
 671      00000000 
 672 0010 00000000 		.word	battery_compal_e88_timer_cb
 673 0014 00000000 		.word	battery_compal88_timer
 674              		.bss
 675              		.align	2
 676              		.set	.LANCHOR0,. + 0
 679              	bat_compal_e88_chg_state:
 680 0000 00000000 		.space	4
 683              	bat_compal_e88_madc_stat:
 684 0004 00000000 		.space	4
 685              		.text
 686              	.Letext0:
DEFINED SYMBOLS
                            *ABS*:0000000000000000 compal_e88.c
     /tmp/cc6mlApP.s:12     .text.bat_compal_e88_goto_state:0000000000000000 $a
     /tmp/cc6mlApP.s:14     .text.bat_compal_e88_goto_state:0000000000000000 bat_compal_e88_goto_state
     /tmp/cc6mlApP.s:136    .text.bat_compal_e88_goto_state:000000000000011c $d
                            *COM*:0000000000000014 battery_info
     /tmp/cc6mlApP.s:147    .text.battery_compal_e88_timer_cb:0000000000000000 $a
     /tmp/cc6mlApP.s:149    .text.battery_compal_e88_timer_cb:0000000000000000 battery_compal_e88_timer_cb
     /tmp/cc6mlApP.s:536    .text.battery_compal_e88_timer_cb:0000000000000344 $d
                            *COM*:0000000000000010 bat_compal_e88_madc
     /tmp/cc6mlApP.s:568    .text.battery_compal_e88_init:0000000000000000 $a
     /tmp/cc6mlApP.s:571    .text.battery_compal_e88_init:0000000000000000 battery_compal_e88_init
     /tmp/cc6mlApP.s:595    .text.battery_compal_e88_init:0000000000000020 $d
     /tmp/cc6mlApP.s:605    .rodata:0000000000000000 $d
     /tmp/cc6mlApP.s:609    .rodata:0000000000000000 bat_compal_e88_chg_state_names
     /tmp/cc6mlApP.s:616    .rodata:0000000000000010 __FUNCTION__.1657
     /tmp/cc6mlApP.s:666    .data:0000000000000000 $d
     /tmp/cc6mlApP.s:670    .data:0000000000000000 battery_compal88_timer
     /tmp/cc6mlApP.s:675    .bss:0000000000000000 $d
     /tmp/cc6mlApP.s:679    .bss:0000000000000000 bat_compal_e88_chg_state
     /tmp/cc6mlApP.s:683    .bss:0000000000000004 bat_compal_e88_madc_stat
                     .debug_frame:0000000000000010 $d

UNDEFINED SYMBOLS
printf
twl3025_reg_write
twl3025_reg_read
__divsi3
twl3025_unit_enable
puts
osmo_timer_schedule
